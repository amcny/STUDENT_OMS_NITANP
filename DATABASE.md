# Firebase Cloud Architecture & Migration Plan

## 1. Architecture Overview

This document outlines the plan to migrate the **Student Outing Management System** to a serverless cloud architecture using the **Google Firebase** ecosystem. This transition moves data persistence, authentication, and background logic off the client browser, enabling real-time synchronization between multiple gates and robust data security.

### Core Services
1.  **Firebase Authentication:** Secure identity management for Gate Security personnel.
2.  **Cloud Firestore:** Real-time, NoSQL database for storing student data and logs.
3.  **Firebase Storage:** Object storage for high-resolution student photographs.
4.  **Cloud Functions:** Server-side logic for automation (e.g., auto-flagging overdue students, cleanup tasks).

---

## 2. Service Breakdown & Usage

### A. Firebase Authentication
*   **Purpose:** Replaces the hardcoded "Front Gate" / "Back Gate" login.
*   **Method:** Email/Password Sign-in.
*   **Roles:**
    *   `admin@nit.edu`: Can manage gates and view all data.
    *   `frontgate@nit.edu`: Assigned `gateId: "Front Gate"`.
    *   `backgate@nit.edu`: Assigned `gateId: "Back Gate"`.

### B. Cloud Firestore (Database)
*   **Purpose:** Stores structured metadata.
*   **Key Feature:** Real-time listeners (`onSnapshot`) ensuring that when a student checks out at the Front Gate, the Back Gate sees the status change instantly.

### C. Firebase Storage
*   **Purpose:** Stores the actual image files (`.jpg`, `.png`).
*   **Optimization:** Currently, the app stores Base64 strings in LocalStorage. This causes performance issues. In the new system:
    1.  Image is uploaded to Storage bucket.
    2.  Storage returns a `downloadURL`.
    3.  Only the `downloadURL` is stored in the Firestore database.

### D. Cloud Functions (Server-Side Logic)
*   **Purpose:** Runs backend code in response to events or schedules, without needing a dedicated server.
*   **Planned Functions:**
    1.  **`checkOverdueCron` (Scheduled):** Runs every 15 minutes. Checks all "Active" logs. If the time exceeds the limit (9 PM for Local, 72h for Non-Local), it tags the document as `isOverdue: true`. This ensures accurate reporting even if no browsers are open.
    2.  **`recursiveDelete` (Trigger):** When a Student document is deleted from Firestore, this function automatically deletes their associated photo from Storage and their history from `outingLogs` to ensure data hygiene.

---

## 3. Database Schema (Firestore)

### Collection: `students`
*   **Document ID:** `studentId` (UUID generated by app or Auto-ID)
*   **Fields:**
    *   `name` (string)
    *   `rollNumber` (string) [Indexed]
    *   `registrationNumber` (string) [Indexed]
    *   `branch` (string)
    *   `year` (string)
    *   `gender` (string)
    *   `studentType` (string)
    *   `hostel` (string)
    *   `roomNumber` (string)
    *   `contactNumber` (string)
    *   `photoUrl` (string) - *Link to Firebase Storage*
    *   `faceFeatures` (array<number>) - *128-float vector for face-api.js matching*
    *   `createdAt` (timestamp)
    *   `updatedAt` (timestamp)

### Collection: `outingLogs`
*   **Document ID:** `logId` (Auto-ID)
*   **Fields:**
    *   `studentId` (string) - *Foreign Key to students*
    *   `studentName` (string) - *Denormalized for faster reads*
    *   `rollNumber` (string) - *Denormalized*
    *   `outingType` (string: "Local" | "Non-Local")
    *   `checkOutTime` (timestamp)
    *   `checkOutGate` (string)
    *   `checkInTime` (timestamp | null)
    *   `checkInGate` (string | null)
    *   `status` (string: "OUT" | "IN" | "OVERDUE") - *Managed by App & Cloud Functions*
    *   `remarks` (string)
    *   `overdueResolved` (boolean)

### Collection: `visitorLogs`
*   **Document ID:** `visitorLogId` (Auto-ID)
*   **Fields:**
    *   `passNumber` (string)
    *   `visitorName` (string)
    *   `mobileNumber` (string)
    *   `relation` (string)
    *   `whomToMeet` (string)
    *   `inTime` (timestamp)
    *   `inGate` (string)
    *   `outTime` (timestamp | null)
    *   `outGate` (string | null)

---

## 4. Storage Schema (Buckets)

*   **Bucket Root**
    *   `/student_photos/`
        *   `{registrationNumber}.jpg`
    *   `/temp/` (For temporary processing if needed)

---

## 5. Implementation Plan (Step-by-Step)

### Step 1: Firebase Configuration
1.  Create Project in Firebase Console.
2.  Register Web App.
3.  Copy configuration (API Key, Auth Domain, Project ID, etc.) to `src/firebaseConfig.ts`.

### Step 2: Setup Authentication
1.  Enable **Email/Password** Sign-in provider in Console.
2.  Create the Gate accounts manually in the console.
3.  Update `Login.tsx` to use `signInWithEmailAndPassword`.

### Step 3: Implement "Student Service" (Firestore + Storage)
1.  Create `services/studentService.ts`.
2.  Implement `addStudent(data, file)`:
    *   Upload `file` to `student_photos/${data.regNo}`.
    *   Get `downloadURL`.
    *   `addDoc` to `students` collection with `photoUrl` and `faceFeatures`.
3.  Implement `getStudents()`:
    *   Use `onSnapshot` to sync student list to local state (Context).

### Step 4: Implement "Outing Service" (Firestore)
1.  Create `services/outingService.ts`.
2.  Implement `checkOut(studentId, gate)`:
    *   `addDoc` to `outingLogs` with `checkOutTime: serverTimestamp()`.
3.  Implement `checkIn(logId, gate)`:
    *   `updateDoc` `outingLogs/${logId}` with `checkInTime: serverTimestamp()`.

### Step 5: Implement Cloud Functions
*   *Requires Firebase CLI (`npm install -g firebase-tools`)*.
*   **Scheduled Function:**
    ```javascript
    exports.checkOverdue = functions.pubsub.schedule('every 15 minutes').onRun(async (context) => {
        const now = admin.firestore.Timestamp.now();
        // Logic to query open logs, calculate duration, and set status='OVERDUE'
    });
    ```
*   Deploy functions using `firebase deploy --only functions`.

### Step 6: Data Migration Utility
Since the app currently uses LocalStorage:
1.  Create a hidden "Admin Migration" button in the Dashboard.
2.  Script logic:
    *   Read `localStorage`.
    *   Loop through all students.
    *   Convert Base64 images to Blobs.
    *   Upload to Storage, Save metadata to Firestore.
    *   Once confirmed successful, clear LocalStorage.

### Step 7: Security Rules
Apply rules to ensure only authenticated gates can read/write.

**Firestore Rules:**
```text
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

---

## 6. Benefits of this Architecture

1.  **Reliability:** No data loss if a browser crashes or cache is cleared.
2.  **Efficiency:** The browser client is lightweight. It loads student metadata (JSON) quickly, and only loads images (via URL) when specifically needed (e.g., viewing a profile), rather than holding 500MB of Base64 strings in RAM.
3.  **Automation:** Cloud Functions handle logic 24/7, ensuring the "Overdue" report is accurate even if no one is logged into the dashboard.
