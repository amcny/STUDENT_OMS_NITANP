# Firebase Backend Architecture Documentation

This document provides a comprehensive technical overview of the Google Firebase backend architecture for the Student Outing Management System. The system is built on a "serverless" model, leveraging integrated Firebase services for data storage, file management, and user authentication to create a robust, scalable, and real-time application.

---

## 1. Firebase Services Overview

The application utilizes the following core Firebase services to deliver its functionality:

| Service                 | Purpose                                                                                                                              | Key Benefits                                                                  |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------- |
| **Cloud Firestore**     | A real-time NoSQL database that serves as the primary data store for all student profiles, outing logs, and visitor pass records.       | Live data synchronization across all clients (Admin, Kiosk) without refreshes. |
| **Cloud Storage**       | A secure and scalable object storage service for hosting all student facial images.                                                  | Efficiently stores and serves binary files (images) globally.                 |
| **Firebase Authentication** | A complete user authentication system that manages secure logins for gate security personnel using email and password.               | Handles all aspects of user sign-in, session management, and security.        |

---

## 2. Cloud Firestore: Database Architecture

The database is structured into three primary top-level collections, designed for efficient querying and data integrity.

### a. `students` Collection

This collection is the master record for every registered student in the institution.

-   **Document ID:** Auto-generated unique Firestore ID (`student.id`).
-   **Document Fields:**
    -   `name`: (string) e.g., "JANE DOE"
    -   `rollNumber`: (string) e.g., "B20CS001" - **Indexed for fast lookups.**
    -   `registrationNumber`: (string) e.g., "6222241" - **Indexed for fast lookups.**
    -   `contactNumber`: (string) e.g., "9876543210"
    -   `branch`: (string) e.g., "Computer Science & Engg."
    -   `year`: (string) e.g., "III"
    -   `gender`: (string) e.g., "Female"
    -   `studentType`: (string) e.g., "Hosteller"
    -   `hostel`: (string) e.g., "Krishnaveni"
    -   `roomNumber`: (string) e.g., "F-214"
    -   `faceImageUrl`: (string) A public, downloadable URL pointing to the student's image in Firebase Storage. This replaces storing inefficient base64 strings in the database.
    -   `faceFeatures`: (array of numbers) The 128-D vector embedding generated by `face-api.js` for facial recognition.
    -   `createdAt`: (timestamp) A server-side timestamp indicating when the student was registered.

### b. `outingLogs` Collection

This collection acts as a comprehensive, immutable log of all student outing activities. It includes denormalized student data to optimize performance for the Logbook view, preventing the need for complex database joins.

-   **Document ID:** Auto-generated unique Firestore ID (`outingRecord.id`).
-   **Document Fields:**
    -   `studentId`: (string) A reference to the document ID in the `students` collection. **Indexed for querying a student's history.**
    -   `studentName`: (string) Denormalized for quick display in logs.
    -   `rollNumber`: (string) Denormalized for display and search.
    -   `year`: (string) Denormalized for filtering.
    -   `gender`: (string) Denormalized for filtering.
    -   `studentType`: (string) Denormalized for filtering.
    -   `outingType`: (string) Either "Local" or "Non-Local".
    -   `checkOutTime`: (timestamp) A Firestore Timestamp object for precise, queryable time. **Indexed for sorting.**
    -   `checkInTime`: (timestamp | null) Initially `null`. Updated on check-in. **Indexed for filtering active vs. completed outings.**
    -   `checkOutGate`: (string) e.g., "Front Gate"
    -   `checkInGate`: (string | null)
    -   `remarks`: (string, optional) Any notes added by the admin or security personnel.
    -   `overdueResolved`: (boolean, optional) Set to `true` if an admin manually clears an overdue status.

### c. `visitorLogs` Collection

This collection stores a complete record of every visitor pass generated at the gates.

-   **Document ID:** Auto-generated unique Firestore ID (`visitorPassRecord.id`).
-   **Document Fields:**
    -   `passNumber`: (string) A uniquely generated pass number (e.g., "V20231027-001"). **Indexed for searching.**
    -   `date`: (timestamp) The date of the visit, used for daily filtering.
    -   `inTime`: (timestamp) The exact time of entry. **Indexed for sorting.**
    -   `outTime`: (timestamp | null) The exact time of departure. **Indexed for filtering active visitors.**
    -   `name`: (string) Visitor's name.
    -   `relation`: (string) Visitor's relation to the person they are meeting.
    -   `mobileNumber`: (string) Visitor's contact number.
    -   `address`: (string)
    -   `vehicleNumber`: (string, optional)
    -   `whomToMeet`: (string) Name of the person being visited.
    -   `placeToVisit`: (string) e.g., "Godavari Hostel", "Admin Building"
    -   `personToMeetMobile`: (string, optional) Mobile number of the person being visited.
    -   `purpose`: (string)
    -   `gateName`: (string) The name of the entry gate.
    -   `outGateName`: (string | null) The name of the exit gate.

---

## 3. Cloud Storage: File Management

Firebase Storage is used exclusively for housing student profile images, keeping the Firestore database lean and fast.

-   **Bucket:** The default Firebase Storage bucket provided with the project.
-   **Folder Path:** `/student_photos/`
-   **File Naming Convention:** `{registrationNumber}.jpg` (e.g., `6222241.jpg`). This standardized convention provides a simple, predictable path, allowing the application to easily retrieve, update, or delete a student's photo without needing to store the full path in the database.

---

## 4. Authentication and Security

### a. User Management

-   **Provider:** The system uses Firebase's built-in **Email/Password** provider for secure authentication.
-   **User Roles:** Users represent gate security personnel. There is no distinction in permissions between users; all authenticated users have the same level of access.
-   **Default Users:** The system is configured with initial users for each gate:
    -   **Email:** `frontgate@nitanp.ac.in` | **Password:** `password123`
    -   **Email:** `backgate@nitanp.ac.in` | **Password:** `password123`
-   **Session Management:** The Firebase SDK handles all session management, including token refresh and persistence, ensuring a user remains logged in across browser sessions.

### b. Security Rules

The following rules are deployed to protect the database and storage bucket from unauthorized access. They enforce a simple but effective policy: only authenticated users can read or write data.

-   **Firestore Rules (`firestore.rules`):**
    ```
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        // All documents in all collections can only be accessed
        // by users who are signed into the application.
        match /{document=**} {
          allow read, write: if request.auth != null;
        }
      }
    }
    ```
-   **Storage Rules (`storage.rules`):**
    ```
    rules_version = '2';
    service firebase.storage {
      match /b/{bucket}/o {
        // All files within the 'student_photos' folder can only be
        // read or written by users who are signed into the application.
        match /student_photos/{fileName} {
          allow read, write: if request.auth != null;
        }
      }
    }
    ```

This architecture provides a secure, scalable, and real-time foundation for the Student Outing Management System, ensuring data integrity and a seamless user experience across all modules of the application.
